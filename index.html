<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор PDF</title>
    <!-- External Libraries for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --oswald-font: 'Oswald', sans-serif;
            --montserrat-font: 'Montserrat', sans-serif;
            --blue-fields-font-size: 14px;
            --white-fields-font-size: 13px;
            --text-color: black;
        }

        body {
            font-family: var(--montserrat-font);
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 2rem;
        }

        h1 {
            color: var(--text-color);
            margin-bottom: 20px;
        }
        
        #controls {
            margin-bottom: 20px;
        }

        #generate-pdf-btn {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 500;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color: 0.3s;
        }

        #generate-pdf-btn:hover {
            background-color: #0056b3;
        }

        #pdf-container {
            width: 1280px;
            height: 720px;
            position: relative;
            background-image: url('https://i.ibb.co/YFRgt7mz/3-1-single-page-template.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Common styles for all input/textarea/select fields */
        .input-field {
            position: absolute;
            background-color: transparent;
            border: 1px dashed rgba(0, 123, 255, 0.5);
            padding: 2px 5px;
            color: var(--text-color);
            box-sizing: border-box;
            overflow: hidden; /* This is crucial */
            resize: none;
            line-height: 1.1; 
        }
        
        .input-field:focus-within, textarea:focus, input:focus {
            outline: none;
            border: 1px solid #007bff;
        }
        
        /* Specific fonts for left and right columns */
        .blue-field {
            font-family: var(--oswald-font);
            font-size: var(--blue-fields-font-size);
        }

        .white-field {
            font-family: var(--montserrat-font);
            font-size: var(--white-fields-font-size);
        }

        /* --- STYLES FOR BOLD LABELS --- */
        .rich-text-field {
            cursor: text; 
        }

        .rich-text-field .field-label {
            font-weight: 700; 
        }

        .rich-text-field .user-input {
            font-weight: 400; 
            outline: none;
            display: inline; 
        }

        /* Specific rule for core-team to start on a new line */
        #core-team .user-input {
            display: block;
        }

        /* Placeholder for contenteditable div */
        .user-input:empty::before {
            content: attr(data-placeholder);
            color: #6c757d;
            cursor: text;
        }

        /* --- Input Field Positioning --- */
        
        /* Left Column */
        #meta, #indicators, #impact, #potential {
            padding: 5px 8px; 
            background-color: #cfe2f3;
            border: 1px dashed black;
        }
        
        #meta { top: 13.5%; left: 4.6%; width: 42.0%; height: 18.4%; }
        #indicators { top: 32.3%; left: 4.6%; width: 42.0%; height: 18.4%; }
        #impact { top: 51.1%; left: 4.6%; width: 42.0%; height: 18.4%; }
        #potential { top: 69.9%; left: 4.6%; width: 42.0%; height: 18.4%; }

        /* Right Column */
        
        .right-column-header {
            position: absolute;
            font-family: var(--montserrat-font);
            font-weight: 700;
            font-size: var(--white-fields-font-size);
            color: var(--text-color);
        }

        #header-subdivision { top: 12.8%; left: 47.0%; }
        #header-category { top: 12.8%; left: 58.3%; }
        #header-type { top: 12.8%; left: 69.3%; }
        #header-defense { top: 12.8%; left: 78.4%; }
        #header-score { top: 12.8%; left: 87.7%; }
        #header-project-title { top: 19.5%; left: 47.0%; }
        #header-project-leader { top: 31.4%; left: 47.0%; }
        #header-priority-direction { top: 38.2%; left: 47.0%; }
        #header-contest-direction { top: 47.3%; left: 47.0%; }
        /* --- NEW HEADERS ADDED --- */
        #header-dates { top: 56.5%; left: 47.0%; }
        #header-funding { top: 63.4%; left: 47.0%; }


        #subdivision { top: 16%; left: 47.0%; width: 10.8%; height: 4%; }
        #category, #type, #defense {
            -webkit-appearance: none; 
            -moz-appearance: none; 
            appearance: none;
            padding-left: 8px; 
        }
        #category { top: 16%; left: 58.3%; width: 10.5%; height: 4%; }
        #type { top: 16%; left: 69.3%; width: 8.5%; height: 4%; }
        #defense { top: 16%; left: 78.4%; width: 7%; height: 4%; }
        #score { top: 16%; left: 87.7%; width: 4.5%; height: 4%; }

        #project-title { top: 22.7%; left: 47.0%; width: 49.3%; height: 9.2%; }
        #project-leader { top: 34.7%; left: 47.0%; width: 49.3%; height: 3%; }
        #priority-direction { top: 41.7%; left: 47.0%; width: 49.3%; height: 5.8%; }
        #contest-direction { top: 50.7%; left: 47.0%; width: 49.3%; height: 5.8%; }

        #date-from-text, #date-to-text {
            position: absolute;
            font-family: var(--montserrat-font);
            font-size: var(--white-fields-font-size);
            top: 61.5%;
            height: 3%;
            display: flex;
            align-items: center;
        }
        #date-from-text { left: 47.0%; }
        #date-to-text { left: 57.5%; }
        
        #start-date { 
            top: 61.5%;
            left: 48.8%; 
            width: 8.5%; 
            height: 3%; 
        }
        #end-date { 
            top: 61.5%;
            left: 59.0%; 
            width: 8.5%; 
            height: 3%; 
        }
        
        #funding-amount {
            top: 66.7%; 
            left: 47.0%;
            width: 12%;
            height: 3%;
        }

        #funding-currency-text {
            position: absolute;
            font-family: var(--montserrat-font);
            font-size: var(--white-fields-font-size);
            top: 67.5%; 
            left: 59.2%;
            height: 3%;
            display: flex;
            align-items: center;
        }

        #core-team {
            top: 70.9%; 
            left: 47.0%;
            width: 49.3%;
            height: 17.5%;
            background-color: #fce5cd;
            border: 1px dashed black;
            padding: 5px 8px;
        }
        
        .no-print .input-field { border: none; }
        input:focus::placeholder, textarea:focus::placeholder { color: transparent; }
        #start-date, #end-date { text-align: center; cursor: pointer; }
        input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0.6; cursor: pointer; }
        input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }
    </style>
</head>
<body>

    <h1>Генератор слайду по Вашій НДР для НТР</h1>
    <div id="controls">
        <button id="generate-pdf-btn">Згенерувати PDF</button>
    </div>

    <div id="pdf-container">
        <!-- Left Side -->
        <div id="meta" class="input-field blue-field rich-text-field">
            <span class="field-label">Мета, завдання: </span><div class="user-input" contenteditable="true" data-placeholder="..."></div>
        </div>
        <div id="indicators" class="input-field blue-field rich-text-field">
            <span class="field-label">Індикатори: </span><div class="user-input" contenteditable="true" data-placeholder="..."></div>
        </div>
        <div id="impact" class="input-field blue-field rich-text-field">
            <span class="field-label">Вплив: </span><div class="user-input" contenteditable="true" data-placeholder="..."></div>
        </div>
        <div id="potential" class="input-field blue-field rich-text-field">
            <span class="field-label">Потенціал: </span><div class="user-input" contenteditable="true" data-placeholder="..."></div>
        </div>

        <!-- Right Side -->
        <div id="header-subdivision" class="right-column-header">Підрозділ</div>
        <div id="header-category" class="right-column-header">Категорія</div>
        <div id="header-type" class="right-column-header">Тип</div>
        <div id="header-defense" class="right-column-header">Оборона</div>
        <div id="header-score" class="right-column-header">Бал</div>
        <div id="header-project-title" class="right-column-header">Назва проєкту:</div>
        <div id="header-project-leader" class="right-column-header">Керівник проєкту:</div>
        <div id="header-priority-direction" class="right-column-header">Пріоритетний напрям розвитку науки і техніки:</div>
        <div id="header-contest-direction" class="right-column-header">Тематичний напрям конкурсу:</div>
        <!-- HEADER ADDED AS REQUESTED -->
        <div id="header-dates" class="right-column-header">Пропоновані терміни виконання:</div>
        <div id="header-funding" class="right-column-header">Орієнтовний обсяг фінансування:</div>

        <input type="text" id="subdivision" class="input-field white-field" placeholder="Підрозділ">
        <select id="category" class="input-field white-field">
            <option value="фунд.">фунд.</option>
            <option value="прикл.">прикл.</option>
        </select>
        <select id="type" class="input-field white-field">
            <option value="експ.">експ.</option>
            <option value="теор.">теор.</option>
        </select>
        <select id="defense" class="input-field white-field">
            <option value="так">так</option>
            <option value="ні">ні</option>
        </select>
        <input type="text" id="score" class="input-field white-field" placeholder="100,00" maxlength="6">
        
        <textarea id="project-title" class="input-field white-field" placeholder="Назва проєкту..."></textarea>
        <input type="text" id="project-leader" class="input-field white-field" placeholder="Керівник проєкту...">
        <textarea id="priority-direction" class="input-field white-field" placeholder="Пріоритетний напрям..."></textarea>
        <textarea id="contest-direction" class="input-field white-field" placeholder="Тематичний напрям..."></textarea>
        
        <span id="date-from-text">від</span>
        <input type="date" id="start-date" class="input-field white-field" min="2000-01-01" max="2099-12-31">
        <span id="date-to-text">до</span>
        <input type="date" id="end-date" class="input-field white-field" min="2000-01-01" max="2099-12-31">
        
        <input type="text" id="funding-amount" class="input-field white-field" placeholder="99...9,99" maxlength="18">
        <span id="funding-currency-text">тис. грн.</span>

        <div id="core-team" class="input-field white-field rich-text-field">
            <span class="field-label">Основний склад: </span><div class="user-input" contenteditable="true" data-placeholder="(приклад: П.І.Б. ..., 80) - кожен з нового рядка"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            const alertTimers = new Map();

            // --- UNIFIED INPUT HANDLING AND CROPPING LOGIC ---
            const handleInput = (event) => {
                const element = event.target;
                const isContentEditable = element.isContentEditable;
                const isSingleLineInput = element.tagName === 'INPUT';
                const container = isContentEditable ? element.parentElement : element;
                const valueProp = isContentEditable ? 'innerText' : 'value';

                // Check for overflow
                const style = window.getComputedStyle(container);
                const isHorizontallyOverflown = isSingleLineInput && (element.scrollWidth > element.clientWidth);
                const isVerticallyOverflown = !isSingleLineInput && (container.scrollHeight > container.clientHeight);

                if (isHorizontallyOverflown || isVerticallyOverflown) {
                    let text = element[valueProp];
                    
                    if (isSingleLineInput) {
                        const inputStyle = window.getComputedStyle(element);
                        const availableWidth = element.clientWidth - parseFloat(inputStyle.paddingLeft) - parseFloat(inputStyle.paddingRight);
                        const tempSpan = document.createElement('span');
                        Object.assign(tempSpan.style, {
                            position: 'absolute', visibility: 'hidden', whiteSpace: 'pre',
                            font: inputStyle.font, letterSpacing: inputStyle.letterSpacing
                        });
                        document.body.appendChild(tempSpan);
                        
                        // Trim characters from the end until it fits
                        while (text.length > 0) {
                            tempSpan.innerText = text;
                            if (tempSpan.getBoundingClientRect().width <= availableWidth) break;
                            text = text.slice(0, -1);
                        }
                        document.body.removeChild(tempSpan);
                    } else { // Multi-line fields
                         // Trim characters while the container overflows
                         const tempClone = container.cloneNode(true);
                         Object.assign(tempClone.style, {
                             position: 'absolute', visibility: 'hidden', height: 'auto',
                             width: style.width, left: '-9999px', top: '-9999px'
                         });
                         const innerElement = isContentEditable ? tempClone.querySelector('.user-input') : tempClone;
                         document.body.appendChild(tempClone);

                         while (text.length > 0) {
                             innerElement[valueProp] = text;
                             if (tempClone.scrollHeight <= container.clientHeight) break;
                             text = text.slice(0, -1);
                         }
                         document.body.removeChild(tempClone);
                    }
                    
                    element[valueProp] = text;

                    // Debounce the alert
                    clearTimeout(alertTimers.get(element));
                    const timer = setTimeout(() => {
                        alert("Ваш текст було обрізано, оскільки він не вміщується в поле.");
                        alertTimers.delete(element);
                    }, 500);
                    alertTimers.set(element, timer);

                    // Move cursor to the end after cropping
                    if(document.activeElement === element) {
                        if(isContentEditable) {
                            const range = document.createRange();
                            const sel = window.getSelection();
                            range.selectNodeContents(element);
                            range.collapse(false);
                            sel.removeAllRanges();
                            sel.addRange(range);
                        }
                    }
                }
            };
            
            // Sanitize paste events before they trigger the input handler
            const handlePaste = (event) => {
                event.preventDefault();
                const element = event.target;
                const isSingleLineInput = element.tagName === 'INPUT';
                let textToPaste = (event.clipboardData || window.clipboardData).getData('text');
                // For single line inputs, remove newlines. For others, replace them with a space.
                textToPaste = textToPaste.replace(/(\r\n|\n|\r)/gm, isSingleLineInput ? '' : ' ');
                document.execCommand('insertText', false, textToPaste);
            };

            // Apply logic to all text fields requiring restriction
            document.querySelectorAll('textarea.input-field, .user-input[contenteditable="true"], input[type="text"].input-field:not(#score):not(#funding-amount)').forEach(field => {
                field.addEventListener('input', handleInput);
                field.addEventListener('paste', handlePaste);
            });


            // --- Focus Logic: Make the entire container clickable ---
            document.querySelectorAll('.rich-text-field').forEach(container => {
                container.addEventListener('click', () => {
                    if (window.getSelection().toString()) return;
                    const userInput = container.querySelector('.user-input');
                    if (userInput && document.activeElement !== userInput) {
                        userInput.focus();
                        const selection = window.getSelection();
                        const range = document.createRange();
                        range.selectNodeContents(userInput);
                        range.collapse(false);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                });
            });

            // --- Date Validation for Manual Input ---
            const handleDateValidation = (event) => {
                const input = event.target;
                if (!input.value) return;
                const minDate = new Date(input.min);
                const maxDate = new Date(input.max);
                const selectedDate = new Date(input.value);
                maxDate.setDate(maxDate.getDate() + 1);
                if (selectedDate < minDate || selectedDate >= maxDate) {
                    alert("Будь ласка, введіть дату між 01.01.2000 та 31.12.2099.");
                    input.value = "";
                }
            };
            document.getElementById('start-date').addEventListener('blur', handleDateValidation);
            document.getElementById('end-date').addEventListener('blur', handleDateValidation);

            // --- Funding Amount & Score Formatting (Unchanged) ---
            const fundingInput = document.getElementById('funding-amount');
            fundingInput.addEventListener('input', (event) => {
                const input = event.target;
                let value = input.value.replace(/\s/g, '').replace(/[^\d,]/g, '');
                const parts = value.split(',');
                let integerPart = (parts.shift() || '').substring(0, 12);
                let decimalPart = parts.length > 0 ? parts.join('').substring(0, 2) : null;
                const formattedIntegerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
                input.value = formattedIntegerPart + (decimalPart !== null ? ',' + decimalPart : (value.includes(',') ? ',' : ''));
            });
            const scoreInput = document.getElementById('score');
            scoreInput.addEventListener('input', (event) => {
                const input = event.target;
                let value = input.value.replace(/[^\d,]/g, '');
                const parts = value.split(',');
                if (parts.length > 2) value = parts[0] + ',' + parts.slice(1).join('');
                if ((parseFloat(value.replace(',', '.')) || 0) > 100) value = '100,00';
                const finalParts = value.split(',');
                let integerPart = finalParts[0] || '';
                let decimalPart = finalParts.length > 1 ? (finalParts[1] || '').substring(0, 2) : null;
                input.value = integerPart + (decimalPart !== null ? ',' + decimalPart : (value.includes(',') ? ',' : ''));
            });
        });

        // --- PDF Generation Logic (Unchanged) ---
        const { jsPDF } = window.jspdf;
        document.getElementById('generate-pdf-btn').addEventListener('click', () => {
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const originalStartDateValue = startDateInput.value;
            const originalEndDateValue = endDateInput.value;
            
            if (originalStartDateValue) {
                const [year, month, day] = originalStartDateValue.split('-');
                startDateInput.type = 'text';
                startDateInput.value = `${day}.${month}.${year}`;
            }
            if (originalEndDateValue) {
                const [year, month, day] = originalEndDateValue.split('-');
                endDateInput.type = 'text';
                endDateInput.value = `${day}.${month}.${year}`;
            }

            document.getElementById('pdf-container').classList.add('no-print');
        
            html2canvas(document.getElementById('pdf-container'), { scale: 3, useCORS: true, logging: true })
            .then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                pdf.addImage(imgData, 'PNG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
                pdf.save("проєктна-пропозиція.pdf");
            }).catch(err => {
                console.error("Помилка при генерації PDF:", err.message);
            }).finally(() => {
                if (originalStartDateValue) {
                    startDateInput.type = 'date';
                    startDateInput.value = originalStartDateValue;
                }
                 if (originalEndDateValue) {
                    endDateInput.type = 'date';
                    endDateInput.value = originalEndDateValue;
                }
                document.getElementById('pdf-container').classList.remove('no-print');
            });
        });
    </script>
</body>
</html>
